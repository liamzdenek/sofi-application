# API Contracts: Experimentation Platform Accelerator

This document defines the TypeScript interfaces and API contracts for the Experimentation Platform Accelerator. These contracts ensure type safety and clear communication between components.

## Core Data Models

```typescript
// Experiment Models
interface Variant {
  id: string;
  name: string;
  config: Record<string, any>; // Flexible configuration object
}

interface Experiment {
  id: string;
  name: string;
  description: string;
  status: 'DRAFT' | 'ACTIVE' | 'PAUSED' | 'COMPLETED';
  variants: Variant[];
  createdAt: string; // ISO date string
  updatedAt: string; // ISO date string
  startDate?: string; // Optional start date
  endDate?: string; // Optional end date
  targetUserPercentage: number; // 0-100, percentage of users to include
}

// Event Models
interface ExperimentEvent {
  id: string;
  experimentId: string;
  variantId: string;
  userId: string;
  sessionId: string;
  action: string; // e.g., 'PAGE_VIEW', 'BUTTON_CLICK', 'CONVERSION'
  metadata?: Record<string, any>; // Additional event data
  timestamp: string; // ISO date string
}

// Report Models
interface ReportMetadata {
  id: string;
  experimentId: string;
  status: 'PENDING' | 'PROCESSING' | 'COMPLETED' | 'FAILED';
  s3Location: string; // S3 URI to the report JSON
  createdAt: string; // ISO date string
  updatedAt: string; // ISO date string
  metrics?: {
    totalEvents: number;
    variantCounts: Record<string, number>;
  };
}

interface ReportData {
  experimentId: string;
  experimentName: string;
  generatedAt: string; // ISO date string
  timeRange: {
    start: string; // ISO date string
    end: string; // ISO date string
  };
  metrics: {
    overall: {
      totalUsers: number;
      totalEvents: number;
      conversionRate: number;
    };
    byVariant: {
      [variantId: string]: {
        users: number;
        events: Record<string, number>; // Action counts
        conversionRate: number;
        improvement?: number; // Percentage improvement over control
        significanceLevel?: number; // p-value if applicable
      };
    };
    timeSeries: {
      // Daily metrics
      dates: string[]; // Array of date strings
      byVariant: {
        [variantId: string]: {
          events: number[];
          conversions: number[];
        };
      };
    };
  };
}
```

## API Contracts

### Experiment Management

```typescript
// Create Experiment
interface CreateExperimentRequest {
  name: string;
  description: string;
  variants: Omit<Variant, 'id'>[]; // Variant without ID (generated by API)
  targetUserPercentage: number;
  startDate?: string;
  endDate?: string;
}

interface CreateExperimentResponse {
  experiment: Experiment;
}

// Get Experiment
interface GetExperimentRequest {
  id: string;
}

interface GetExperimentResponse {
  experiment: Experiment;
}

// List Experiments
interface ListExperimentsRequest {
  status?: 'DRAFT' | 'ACTIVE' | 'PAUSED' | 'COMPLETED';
  limit?: number;
  offset?: number;
}

interface ListExperimentsResponse {
  experiments: Experiment[];
  total: number;
}

// Update Experiment
interface UpdateExperimentRequest {
  id: string;
  name?: string;
  description?: string;
  status?: 'DRAFT' | 'ACTIVE' | 'PAUSED' | 'COMPLETED';
  variants?: Variant[];
  targetUserPercentage?: number;
  startDate?: string;
  endDate?: string;
}

interface UpdateExperimentResponse {
  experiment: Experiment;
}
```

### Event Collection

```typescript
// Record Event
interface RecordEventRequest {
  experimentId: string;
  variantId: string;
  userId: string;
  sessionId: string;
  action: string;
  metadata?: Record<string, any>;
}

interface RecordEventResponse {
  success: boolean;
  eventId: string;
}

// Batch Record Events
interface BatchRecordEventsRequest {
  events: Omit<ExperimentEvent, 'id' | 'timestamp'>[];
}

interface BatchRecordEventsResponse {
  success: boolean;
  eventIds: string[];
}
```

### Experiment Assignment (for Sample Page)

```typescript
// Get Active Experiments for User
interface GetActiveExperimentsRequest {
  userId: string;
  sessionId: string;
}

interface GetActiveExperimentsResponse {
  experiments: Array<{
    experimentId: string;
    variantId: string;
    config: Record<string, any>;
  }>;
}
```

### Report Management

```typescript
// Generate Report
interface GenerateReportRequest {
  experimentId: string;
  timeRange?: {
    start: string; // ISO date string
    end: string; // ISO date string
  };
}

interface GenerateReportResponse {
  reportId: string;
  status: 'PENDING';
}

// Get Report Metadata
interface GetReportRequest {
  id: string;
}

interface GetReportResponse {
  report: ReportMetadata;
}

// List Reports
interface ListReportsRequest {
  experimentId?: string;
  status?: 'PENDING' | 'PROCESSING' | 'COMPLETED' | 'FAILED';
  limit?: number;
  offset?: number;
}

interface ListReportsResponse {
  reports: ReportMetadata[];
  total: number;
}

// Get Report Data
interface GetReportDataRequest {
  id: string;
}

interface GetReportDataResponse {
  reportData: ReportData;
}
```

## Component Data Flows

### 1. Web UI to API: Creating Experiments

```typescript
// UI sends CreateExperimentRequest to API
const createExperimentRequest: CreateExperimentRequest = {
  name: "Button Color Test",
  description: "Testing impact of button color on conversion",
  variants: [
    {
      name: "Control",
      config: { buttonColor: "blue" }
    },
    {
      name: "Treatment",
      config: { buttonColor: "green" }
    }
  ],
  targetUserPercentage: 100
};

// API responds with CreateExperimentResponse
const createExperimentResponse: CreateExperimentResponse = {
  experiment: {
    id: "exp123",
    name: "Button Color Test",
    description: "Testing impact of button color on conversion",
    status: "DRAFT",
    variants: [
      {
        id: "var1",
        name: "Control",
        config: { buttonColor: "blue" }
      },
      {
        id: "var2",
        name: "Treatment",
        config: { buttonColor: "green" }
      }
    ],
    targetUserPercentage: 100,
    createdAt: "2025-03-20T12:00:00Z",
    updatedAt: "2025-03-20T12:00:00Z"
  }
};
```

### 2. Sample Page to API: Getting Experiment Configuration

```typescript
// Sample page sends GetActiveExperimentsRequest to API
const getActiveExperimentsRequest: GetActiveExperimentsRequest = {
  userId: "user123",
  sessionId: "session456"
};

// API responds with GetActiveExperimentsResponse
const getActiveExperimentsResponse: GetActiveExperimentsResponse = {
  experiments: [
    {
      experimentId: "exp123",
      variantId: "var2",
      config: { buttonColor: "green" }
    }
  ]
};
```

### 3. Sample Page to API: Recording Events

```typescript
// Sample page sends RecordEventRequest to API
const recordEventRequest: RecordEventRequest = {
  experimentId: "exp123",
  variantId: "var2",
  userId: "user123",
  sessionId: "session456",
  action: "BUTTON_CLICK",
  metadata: { 
    pageLocation: "hero-section",
    timeOnPage: 45 // seconds
  }
};

// API responds with RecordEventResponse
const recordEventResponse: RecordEventResponse = {
  success: true,
  eventId: "evt789"
};
```

### 4. UI to API: Triggering Report Generation

```typescript
// UI sends GenerateReportRequest to API
const generateReportRequest: GenerateReportRequest = {
  experimentId: "exp123",
  timeRange: {
    start: "2025-03-19T00:00:00Z",
    end: "2025-03-20T23:59:59Z"
  }
};

// API responds with GenerateReportResponse
const generateReportResponse: GenerateReportResponse = {
  reportId: "rep456",
  status: "PENDING"
};
```

### 5. API to AWS Batch: Report Generation Job Parameters

```typescript
// API sends job parameters to AWS Batch (Java object equivalent)
interface ReportJobParameters {
  experimentId: string;
  reportId: string;
  timeRange: {
    start: string;
    end: string;
  };
  outputBucket: string;
  outputKey: string;
}

const reportJobParameters: ReportJobParameters = {
  experimentId: "exp123",
  reportId: "rep456",
  timeRange: {
    start: "2025-03-19T00:00:00Z",
    end: "2025-03-20T23:59:59Z"
  },
  outputBucket: "experimentation-platform-reports",
  outputKey: "reports/exp123/rep456.json"
};
```

### 6. AWS Batch to S3: Report JSON Structure

The Java AWS Batch job will generate a JSON report with the following structure (equivalent to the TypeScript ReportData interface):

```json
{
  "experimentId": "exp123",
  "experimentName": "Button Color Test",
  "generatedAt": "2025-03-20T14:30:00Z",
  "timeRange": {
    "start": "2025-03-19T00:00:00Z",
    "end": "2025-03-20T23:59:59Z"
  },
  "metrics": {
    "overall": {
      "totalUsers": 1250,
      "totalEvents": 3750,
      "conversionRate": 0.15
    },
    "byVariant": {
      "var1": {
        "users": 625,
        "events": {
          "PAGE_VIEW": 625,
          "BUTTON_CLICK": 75,
          "CONVERSION": 75
        },
        "conversionRate": 0.12
      },
      "var2": {
        "users": 625,
        "events": {
          "PAGE_VIEW": 625,
          "BUTTON_CLICK": 125,
          "CONVERSION": 112
        },
        "conversionRate": 0.18,
        "improvement": 50.0,
        "significanceLevel": 0.03
      }
    },
    "timeSeries": {
      "dates": ["2025-03-19", "2025-03-20"],
      "byVariant": {
        "var1": {
          "events": [300, 325],
          "conversions": [36, 39]
        },
        "var2": {
          "events": [310, 315],
          "conversions": [56, 56]
        }
      }
    }
  }
}
```

### 7. UI to API: Fetching Reports

```typescript
// UI sends ListReportsRequest to API
const listReportsRequest: ListReportsRequest = {
  experimentId: "exp123",
  status: "COMPLETED"
};

// API responds with ListReportsResponse
const listReportsResponse: ListReportsResponse = {
  reports: [
    {
      id: "rep456",
      experimentId: "exp123",
      status: "COMPLETED",
      s3Location: "reports/exp123/rep456.json",
      createdAt: "2025-03-20T14:00:00Z",
      updatedAt: "2025-03-20T14:30:00Z",
      metrics: {
        totalEvents: 3750,
        variantCounts: {
          "var1": 1250,
          "var2": 1250
        }
      }
    }
  ],
  total: 1
};

// UI sends GetReportDataRequest to API
const getReportDataRequest: GetReportDataRequest = {
  id: "rep456"
};

// API responds with GetReportDataResponse containing the full report data
const getReportDataResponse: GetReportDataResponse = {
  reportData: {
    // Full report data structure as shown in the JSON example above
    experimentId: "exp123",
    experimentName: "Button Color Test",
    generatedAt: "2025-03-20T14:30:00Z",
    timeRange: {
      start: "2025-03-19T00:00:00Z",
      end: "2025-03-20T23:59:59Z"
    },
    metrics: {
      // ... full metrics as shown in the JSON example
    }
  }
};
```

## Implementation Notes

1. **TypeScript Implementation**:
   - All API endpoints will be implemented in TypeScript using Lambda functions
   - The React UI will use these TypeScript interfaces for type safety
   - AWS SDK calls will be properly typed

2. **Java AWS Batch Job**:
   - Will use the AWS SDK for Java
   - Will implement equivalent Java classes for the TypeScript interfaces
   - Will use Jackson for JSON serialization/deserialization
   - Will implement statistical analysis for experiment results

3. **DynamoDB Schema Optimization**:
   - Experiments table: Hash key on `id`
   - Events table: Hash key on `experimentId`, sort key on `timestamp`
   - Reports table: Hash key on `id`, GSI on `experimentId`

4. **API Implementation**:
   - RESTful API with consistent error handling
   - All endpoints will return appropriate HTTP status codes
   - Validation for all request parameters